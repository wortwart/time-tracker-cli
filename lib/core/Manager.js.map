{"version":3,"sources":["../../src/core/Manager.js"],"names":["Manager","cfg","repositories","tasks","all","config","key","task","props","myTasks","Object","keys","forEach","filter","_st","status","only_key","push","_task","lastLog","log","length","update","get","assign","set","description","t","getTask","start","then","storeTask","console","toISOString","catch","pauseTask","running_tasks","getAllTasks","el","pause","unpauseTask","paused_tasks","unpause","stop","text","setDescription","name","getSeconds","operation","stringTime","makeOperationOverTime","string","indexOf","search","map","k","join","prompt","type","message","default","answers","cls","unflatten","element","value","configElements","toString","newCfg","newTasks","migratedTasks","args","full","rate","timespan","format","view"],"mappings":"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","file":"Manager.js","sourcesContent":["import flat from 'flat'\nimport moment from 'moment'\nimport inquirer from 'inquirer'\n\nimport Task from './Task'\nimport {recognizeModifierTiming} from './utils'\nimport {STARTED, PAUSED, UNPAUSED, IN_PROGRESS, FINISHED, configElements} from './constants'\nimport {summarize, outputVertical, cliError, cliSuccess} from './output'\nimport {migrateToV2} from './dbMigrations'\n\nexport default class Manager {\n\n\trepositories = ['tasks', 'config']\n\n\tconstructor(cfg) {\n\t\tthis.cfg = cfg\n\t\tthis.tasks = cfg.all.tasks\n\t\tthis.config = (cfg.all.config) ? cfg.all.config : {}\n\t}\n\n\tgetTask(key) {\n\t\tlet task = (this.tasks[key]) ? this.tasks[key] : null\n\t\treturn new Task(task)\n\t}\n\n\tgetAllTasks(props) {\n\t\tlet myTasks = []\n\t\tif (!props) props = {}\n\t\tObject.keys(this.tasks).forEach(key => {\n\t\t\tif (props.filter) {\n\t\t\t\tlet _st = this.tasks[key].status\n\t\t\t\tif (props.filter === 'unfinished') {\n\t\t\t\t\tif (_st === FINISHED)\n\t\t\t\t\t\treturn\n\t\t\t\t} else if (props.filter === 'running') {\n\t\t\t\t\tif (_st === FINISHED || _st === PAUSED)\n\t\t\t\t\t\treturn\n\t\t\t\t} else if (props.filter === 'paused') {\n\t\t\t\t\tif (_st !== PAUSED)\n\t\t\t\t\t\treturn\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (props.only_key) {\n\t\t\t\tmyTasks.push(key)\n\t\t\t\treturn\n\t\t\t}\n\t\t\tlet _task = {key: key}\n\t\t\tif (props.status)\n\t\t\t\t_task.status = this.tasks[key].status\n\t\t\tif (props.lastLog)\n\t\t\t\t_task.lastLog = this.tasks[key].log[this.tasks[key].log.length - 1]\n\t\t\tmyTasks.push(_task)\n\t\t})\n\t\treturn myTasks\n\t}\n\n\tstoreTask(key, task) {\n\t\tlet update = {}\n\t\tupdate[key] = task.get()\n\t\tthis.tasks = Object.assign({}, this.tasks, update)\n\t\tthis.cfg.set('tasks', this.tasks)\n\t}\n\n\tstartTask(key, description) {\n\t\tlet t = this.getTask(key)\n\t\tt.start(description)\n\t\t\t.then(() => {\n\t\t\t\tthis.storeTask(key, t)\n\t\t\t\tconsole.log(\n\t\t\t\t\toutputVertical('Task:', key, STARTED, moment().toISOString())\n\t\t\t\t)\n\t\t\t}, cliError)\n\t\t\t.catch(cliError)\n\t}\n\n\tpauseTasks(key) {\n\t\tif (key) {\n\t\t\tthis.pauseTask(key)\n\t\t\treturn\n\t\t}\n\t\tlet running_tasks = this.getAllTasks({filter: 'running', only_key: true})\n\t\trunning_tasks.forEach(el => this.pauseTask(el))\n\t\tconsole.log('Pausing', running_tasks.length, 'Task(s)')\n\t}\n\n\tpauseTask(key) {\n\t\tlet t = this.getTask(key)\n\t\tt.pause()\n\t\t\t.then(()=>{\n\t\t\t\tthis.storeTask(key, t)\n\t\t\t\tconsole.log(\n\t\t\t\t\toutputVertical('Task:', key, PAUSED, moment().toISOString())\n\t\t\t\t)\n\t\t\t}, cliError)\n\t\t\t.catch(cliError)\n\t}\n\n\tunpauseTasks(key) {\n\t\tif (key) {\n\t\t\tthis.unpauseTask(key)\n\t\t\treturn\n\t\t}\n\t\tlet paused_tasks = this.getAllTasks({filter: 'paused', only_key: true})\n\t\tpaused_tasks.forEach(el => this.unpauseTask(el))\n\t\tconsole.log('Unpausing', paused_tasks.length, 'Task(s)')\n\t}\n\n\tunpauseTask(key) {\n\t\tlet t = this.getTask(key)\n\t\tt.unpause()\n\t\t\t.then(()=>{\n\t\t\t\tthis.storeTask(key, t)\n\t\t\t\tconsole.log(\n\t\t\t\t\toutputVertical('Task:', key, UNPAUSED, moment().toISOString())\n\t\t\t\t)\n\t\t\t}, cliError)\n\t\t\t.catch(cliError)\n\t}\n\n\tstopTask(key, description) {\n\t\tlet t = this.getTask(key)\n\t\tt.stop(description)\n\t\t\t.then(()=>{\n\t\t\t\tthis.storeTask(key, t)\n\t\t\t\tconsole.log(\n\t\t\t\t\toutputVertical('Task:', key, FINISHED, moment().toISOString())\n\t\t\t\t)\n\t\t\t}, cliError)\n\t\t\t.catch(cliError)\n\t}\n\n\taddDescription(key, text) {\n\t\tlet t = this.getTask(key)\n\t\tt.setDescription(text)\n\t\tthis.storeTask(key, t)\n\t}\n\n\tgetTime(name) {\n\t\tlet t = this.getTask(name)\n\t\treturn t.getSeconds()\n\t}\n\n\tmodifyTask(operation, name, stringTime) {\n\t\tlet t = this.getTask(name)\n\t\tt.makeOperationOverTime(operation, stringTime)\n\t\t\t.then(()=>{\n\t\t\t\tthis.storeTask(name, t)\n\t\t\t}, cliError)\n\t\t\t.catch(cliError)\n\t}\n\n\tsearch(string) {\n\t\tlet keys = Object.keys(this.tasks)\n\t\tlet tasks = []\n\t\tkeys.forEach((key)=>{\n\t\t\tif (string === 'all' || key.indexOf(string) > -1){\n\t\t\t\ttasks.push({\n\t\t\t\t\tname: key,\n\t\t\t\t\ttask: new Task(this.tasks[key])\n\t\t\t\t})\n\t\t\t}\n\t\t})\n\t\treturn tasks\n\t}\n\n\tdelete(string) {\n\t\tlet tasks = this.search(string)\n\t\tconsole.log(tasks.map(k => `${k.name} \\n`).join(''))\n\t\tif (tasks.length === 0) {\n\t\t\tcliSuccess('No tasks found to delete.')\n\t\t\treturn\n\t\t}\n\t\tinquirer.prompt([{\n\t\t\ttype: 'confirm',\n\t\t\tname: 'cls',\n\t\t\tmessage: `Are you sure you want to delete this tasks?`,\n\t\t\tdefault: false\n\t\t}]).then((answers) => {\n\t\t\tif (answers.cls){\n\t\t\t\ttasks.forEach(k => {\n\t\t\t\t\tdelete this.tasks[k.name]\n\t\t\t\t\tthis.cfg.set('tasks', this.tasks)\n\t\t\t\t})\n\t\t\t\tcliSuccess('Tasks deleted.')\n\t\t\t}\n\t\t})\n\t\t.catch(cliError)\n\t}\n\n\tgetTasksJson() {\n\t\treturn flat.unflatten(this.tasks)\n\t}\n\n\tgetConfig() {\n\t\treturn this.config\n\t}\n\n\tconfigure(element, value) {\n\t\tif (configElements.indexOf(element) < 0)\n\t\t\treturn cliError(`Config key (${element}) not allowed, allowed keys: ${this.configElements.toString()} `)\n\t\tlet newCfg = {[element]: value}\n\t\tthis.config = Object.assign({}, this.config, newCfg)\n\t\tthis.cfg.set('config', this.config)\n\t\treturn this.config\n\t}\n\n\tupdate() {\n\t\tif (!this.config || (this.config && this.config['config.version'] !== '2') ) {\n\t\t\tconsole.log('DB: Need to be updated')\n\t\t\tmigrateToV2(this.tasks)\n\t\t\t\t.then(tasks => {\n\t\t\t\t\tlet newTasks = {}\n\t\t\t\t\ttasks.forEach(t => newTasks[t.key] = t.task)\n\t\t\t\t\treturn newTasks\n\t\t\t\t})\n\t\t\t\t.then(migratedTasks => {\n\t\t\t\t\tthis.cfg.set('tasks', migratedTasks)\n\t\t\t\t\tthis.cfg.set('config', Object.assign(this.config, {\n\t\t\t\t\t\t'config.version': '2'\n\t\t\t\t\t}))\n\t\t\t\t\tcliSuccess('Configuration migrated to version 2.')\n\t\t\t\t}, cliError)\n\t\t\t\t.catch(cliError)\n\t\t} else {\n\t\t\tcliSuccess('No need to update the DB.')\n\t\t}\n\t}\n\n\tsummarize(args) {\n\t\tif (typeof args.full === 'undefined') args.full = true\n\t\tsummarize({\n\t\t\tsearch: args.key,\n\t\t\ttasks: this.search(args.key),\n\t\t\trate: args.rate,\n\t\t\tfull: args.full,\n\t\t\ttimespan: args.timespan,\n\t\t\tformat: this.config['format.output']\n\t\t})\n\t}\n\n\tgetStatus() {\n\t\tlet keys = this.getAllTasks({view: 'list', status: true, lastLog: true})\n\t\tkeys.forEach(el => {\n\t\t\tconsole.log(el.key, el.status, el.lastLog)\n\t\t})\n\t}\n\n}\n"]}